rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner() {
      return request.auth != null && request.auth.uid == resource.data.ownerId;
    }
    
    function isServiceProfessional() {
      return request.auth != null && resource.data.role == 'serviceProfessional';
    }
    
    function isOwnerOrProfessional() {
      return request.auth != null && (
        resource.data.ownerId == request.auth.uid || 
        resource.data.repairProfessionalId == request.auth.uid ||
        resource.data.customerId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid
      );
    }
    
    // Users can read/write their own profile
    // Allow public read for service professionals (for search/browsing)
    // Allow authenticated users to read all profiles
    match /users/{userId} {
      allow read: if true; // Allow public read for search functionality
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Damage report owners can read/write their reports, professionals can read pending reports
    match /damage_reports/{reportId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource == null || resource.data.ownerId == request.auth.uid);
    }
    
    // Estimates collection (updated to support both systems)
    match /estimates/{estimateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        // Allow update if user is the owner (either direct ownerId or through report)
        resource.data.ownerId == request.auth.uid ||
        resource.data.repairProfessionalId == request.auth.uid ||
        resource.data.customerId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid ||
        // Allow update if user owns the damage report this estimate is for
        (resource.data.reportId != null && 
         exists(/databases/$(database)/documents/damage_reports/$(resource.data.reportId)) &&
         get(/databases/$(database)/documents/damage_reports/$(resource.data.reportId)).data.ownerId == request.auth.uid)
      );
      allow delete: if false; // Soft delete only
    }
    
    // Service categories - allow public read (for browsing/search), authenticated write (for seeding)
    match /service_categories/{categoryId} {
      allow read: if true; // Allow public read for homepage/search
      allow create, update: if isAuthenticated();
    }
    
    // Job requests - allow authenticated users to read and create
    match /job_requests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid
      );
    }
    
    // Service professionals - allow public read (for search/browsing), authenticated write
    match /service_professionals/{professionalId} {
      allow read: if true; // Allow public read for search functionality
      allow write: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid ||
        resource == null // Allow create if document doesn't exist
      );
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Chat rooms - allow participants to read/write
    match /chat_rooms/{roomId} {
      allow read: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid
      );
      allow create: if isAuthenticated() && (
        request.resource.data.customerId == request.auth.uid ||
        request.resource.data.professionalId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid
      );
    }
    
    // Allow querying chat rooms collection for authenticated users
    // This is needed for getUserChatRoomsStream to work
    match /chat_rooms/{roomId} {
      allow list: if isAuthenticated();
    }
    
    // Chat messages - allow participants of the chat room to read/write
    match /chat_rooms/{roomId}/messages/{messageId} {
      allow read: if isAuthenticated() && (
        exists(/databases/$(database)/documents/chat_rooms/$(roomId)) &&
        (get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.customerId == request.auth.uid ||
         get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.professionalId == request.auth.uid)
      );
      allow create: if isAuthenticated() && (
        exists(/databases/$(database)/documents/chat_rooms/$(roomId)) &&
        (get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.customerId == request.auth.uid ||
         get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.professionalId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        exists(/databases/$(database)/documents/chat_rooms/$(roomId)) &&
        (get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.customerId == request.auth.uid ||
         get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.professionalId == request.auth.uid)
      );
    }
    
    // Chat messages collection (separate collection used by the app)
    match /chat_messages/{messageId} {
      allow read: if isAuthenticated() && (
        exists(/databases/$(database)/documents/chat_rooms/$(resource.data.chatRoomId)) &&
        (get(/databases/$(database)/documents/chat_rooms/$(resource.data.chatRoomId)).data.customerId == request.auth.uid ||
         get(/databases/$(database)/documents/chat_rooms/$(resource.data.chatRoomId)).data.professionalId == request.auth.uid)
      );
      allow create: if isAuthenticated() && (
        exists(/databases/$(database)/documents/chat_rooms/$(request.resource.data.chatRoomId)) &&
        (get(/databases/$(database)/documents/chat_rooms/$(request.resource.data.chatRoomId)).data.customerId == request.auth.uid ||
         get(/databases/$(database)/documents/chat_rooms/$(request.resource.data.chatRoomId)).data.professionalId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        exists(/databases/$(database)/documents/chat_rooms/$(resource.data.chatRoomId)) &&
        (get(/databases/$(database)/documents/chat_rooms/$(resource.data.chatRoomId)).data.customerId == request.auth.uid ||
         get(/databases/$(database)/documents/chat_rooms/$(resource.data.chatRoomId)).data.professionalId == request.auth.uid)
      );
    }
    
    // Bookings - allow participants to read/write
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid
      );
      allow create: if isAuthenticated() && (
        request.resource.data.customerId == request.auth.uid ||
        request.resource.data.professionalId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid
      );
      // Allow list queries for authenticated users (needed for booking queries)
      allow list: if isAuthenticated();
    }
    
    // Professional availability - professionals can manage their own, customers can read
    match /professional_availability/{availabilityId} {
      allow read: if isAuthenticated(); // Allow authenticated users to read availability for booking
      allow create: if isAuthenticated() && (
        // Allow if professionalId matches userId OR if user owns the service_professional document
        request.resource.data.professionalId == request.auth.uid ||
        (exists(/databases/$(database)/documents/service_professionals/$(request.resource.data.professionalId)) &&
         get(/databases/$(database)/documents/service_professionals/$(request.resource.data.professionalId)).data.userId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        // Allow if professionalId matches userId OR if user owns the service_professional document
        resource.data.professionalId == request.auth.uid ||
        (exists(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)) &&
         get(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)).data.userId == request.auth.uid)
      );
      allow delete: if isAuthenticated() && (
        // Allow if professionalId matches userId OR if user owns the service_professional document
        resource.data.professionalId == request.auth.uid ||
        (exists(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)) &&
         get(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)).data.userId == request.auth.uid)
      );
      // Allow list queries for authenticated users
      allow list: if isAuthenticated();
    }
    
    // Time slots - professionals can manage their own, customers can read available slots
    match /time_slots/{slotId} {
      allow read: if isAuthenticated(); // Allow authenticated users to read time slots for booking
      allow create: if isAuthenticated() && (
        // Allow if professionalId matches userId OR if user owns the service_professional document
        request.resource.data.professionalId == request.auth.uid ||
        (exists(/databases/$(database)/documents/service_professionals/$(request.resource.data.professionalId)) &&
         get(/databases/$(database)/documents/service_professionals/$(request.resource.data.professionalId)).data.userId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        // Allow if professionalId matches userId OR if user owns the service_professional document
        resource.data.professionalId == request.auth.uid ||
        (exists(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)) &&
         get(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)).data.userId == request.auth.uid) ||
        // Allow authenticated users to update slots when booking (marking as unavailable)
        // The booking itself will be validated by the bookings collection rules
        (resource.data.isAvailable == true && 
         request.resource.data.isAvailable == false &&
         request.resource.data.bookingId != null)
      );
      allow delete: if isAuthenticated() && (
        // Allow if professionalId matches userId OR if user owns the service_professional document
        resource.data.professionalId == request.auth.uid ||
        (exists(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)) &&
         get(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)).data.userId == request.auth.uid)
      );
      // Allow list queries for authenticated users (needed for composite queries)
      allow list: if isAuthenticated();
    }
    
    // Booking conflicts - professionals can read/write conflicts for their bookings
    match /booking_conflicts/{conflictId} {
      allow read: if isAuthenticated() && (
        resource.data.professionalId == request.auth.uid ||
        // Allow if professionalId matches userId in service_professionals document
        (exists(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)) &&
         get(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)).data.userId == request.auth.uid)
      );
      allow create: if isAuthenticated() && (
        request.resource.data.professionalId == request.auth.uid ||
        // Allow if professionalId matches userId in service_professionals document
        (exists(/databases/$(database)/documents/service_professionals/$(request.resource.data.professionalId)) &&
         get(/databases/$(database)/documents/service_professionals/$(request.resource.data.professionalId)).data.userId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        resource.data.professionalId == request.auth.uid ||
        // Allow if professionalId matches userId in service_professionals document
        (exists(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)) &&
         get(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)).data.userId == request.auth.uid)
      );
      allow delete: if isAuthenticated() && (
        resource.data.professionalId == request.auth.uid ||
        // Allow if professionalId matches userId in service_professionals document
        (exists(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)) &&
         get(/databases/$(database)/documents/service_professionals/$(resource.data.professionalId)).data.userId == request.auth.uid)
      );
    }
    
    // Reviews - allow public read (for browsing profiles), but only authenticated users can create/update their own
    match /reviews/{reviewId} {
      allow read: if true; // Allow public read for unauthenticated users
      allow create: if isAuthenticated() && (
        request.resource.data.customerId == request.auth.uid ||
        request.resource.data.professionalId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid
      );
      allow delete: if false; // Prevent deletion of reviews
    }
    
    // Professional reviews - allow public read (for browsing profiles), but only authenticated users can create/update their own
    match /professional_reviews/{reviewId} {
      allow read: if true; // Allow public read for unauthenticated users
      allow create: if isAuthenticated() && (
        request.resource.data.customerId == request.auth.uid ||
        request.resource.data.professionalId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid
      );
      allow delete: if false; // Prevent deletion of reviews
    }
    
    // Professional balances - allow service professionals to read/write their own balance
    match /professional_balances/{professionalId} {
      allow read, write: if isAuthenticated() && request.auth.uid == professionalId;
    }
    
    // Payouts - allow service professionals to read their own payouts only
    // TODO: Add admin role check if you implement admin role system
    match /payouts/{payoutId} {
      allow read: if isAuthenticated() && resource.data.professionalId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.professionalId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.professionalId == request.auth.uid;
      // To allow admins, uncomment and modify:
      // allow read, update: if isAuthenticated() && 
      //   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Usernames collection - for checking username availability
    match /usernames/{username} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Notifications - users can read their own notifications, and create notifications for any user
    match /notifications/{notificationId} {
      // Allow read if user owns the notification
      allow read: if isAuthenticated() && (
        resource == null || // Allow read if document doesn't exist (for queries)
        resource.data.userId == request.auth.uid
      );
      // Allow create for any authenticated user (notifications are sent TO users, not BY users)
      // The userId field indicates the recipient, not the sender
      allow create: if isAuthenticated() && request.resource.data.userId != null;
      // Allow update if user owns the notification OR if updating status/sentAt/readAt fields
      // This allows the notification service to update status after sending
      // We check that userId doesn't change to prevent unauthorized updates
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || // User updating their own notification
        // Allow updates to status/sentAt/readAt fields as long as userId doesn't change
        (request.resource.data.userId == resource.data.userId &&
         request.resource.data.userId != null)
      );
      // Allow delete if user owns the notification
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Allow list queries for authenticated users (needed for scheduled notifications)
      allow list: if isAuthenticated();
    }
    
    // Notification templates - allow authenticated users to read and create (for default templates)
    match /notification_templates/{templateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Allow creation of default templates
      allow update, delete: if false; // Only admins can modify/delete templates
    }
    
    // Notification channels - allow authenticated users to read
    match /notification_channels/{channelId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admins can modify channels
    }
    
    // Notification preferences - users can only read/write their own preferences
    match /notification_preferences/{userId} {
      // Allow read if user matches (even if document doesn't exist)
      // This allows reading your own preferences even if the document hasn't been created yet
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Allow create if user is setting their own userId
      allow create: if isAuthenticated() && request.auth.uid == userId && request.resource.data.userId == userId;
      // Allow update if user matches (even if document doesn't exist - will create it)
      allow update: if isAuthenticated() && request.auth.uid == userId && (
        resource == null || // Allow update even if document doesn't exist yet (creates it)
        resource.data.userId == userId || // Or if document exists and user owns it
        request.resource.data.userId == userId // Or if setting userId to match
      );
      // Allow delete if user matches
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Job summaries - allow participants to read/write
    match /job_summaries/{summaryId} {
      allow read: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid
      );
      allow create: if isAuthenticated() && (
        request.resource.data.customerId == request.auth.uid ||
        request.resource.data.professionalId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid
      );
    }
  }
}